<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>í‚¤ì›Œë“œ ë¶„ì„ - ë…¸ë¬´ì‚¬ í•™ìŠµ í”Œë˜ë„ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
</head>
<body>
    <div style="position: absolute; top: 10px; right: 10px; text-align: right;">
        <div><span id="authStatus">í™•ì¸ ì¤‘...</span></div>
        <div>
            <a href="login.html" id="loginLink">ë¡œê·¸ì¸</a>
            <button id="logoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <h1 id="examTitle">í‚¤ì›Œë“œ ë¶„ì„</h1>

    <p><a href="checklist.html">ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°</a></p>

    <hr>

    <h2>í‚¤ì›Œë“œ ì…ë ¥</h2>

    <div>
        <label for="viewModeSelect">ì¡°íšŒ ëª¨ë“œ: </label>
        <select id="viewModeSelect">
            <option value="single">ë‹¨ì¼ ì—°ë„</option>
            <option value="3years">ìµœê·¼ 3ê°œë…„ í†µí•©</option>
            <option value="5years">ìµœê·¼ 5ê°œë…„ í†µí•©</option>
        </select>
        &nbsp;&nbsp;
        <label for="subjectSelect">ê³¼ëª© ì„ íƒ: </label>
        <select id="subjectSelect">
            <option value="ì „ì²´">ì „ì²´</option>
        </select>
    </div>
    <br>

    <div id="multiYearInfo" style="display:none; background-color: #e8f4f8; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
        <strong>ğŸ“Š í†µí•© ì •ë³´:</strong> <span id="yearRangeText"></span> |
        <strong>ì´ í‚¤ì›Œë“œ ìˆ˜:</strong> <span id="totalKeywordCount">0</span>
    </div>

    <p>ì‹œí—˜ ë¬¸ì œë¥¼ ë³´ë©´ì„œ ìì£¼ ë‚˜ì˜¤ëŠ” ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (í•œ ì¤„ì— í•˜ë‚˜ì”©)</p>

    <textarea id="keywordInput" rows="10" cols="50" placeholder="ì˜ˆ:&#10;ê·¼ë¡œê¸°ì¤€ë²•&#10;ì„ê¸ˆ&#10;í‡´ì§ê¸ˆ&#10;íœ´ê°€"></textarea>
    <br>
    <button id="generateBtn">ì›Œë“œ í´ë¼ìš°ë“œ ìƒì„±</button>
    <button id="saveBtn">ì €ì¥</button>
    <button id="clearBtn">ì´ˆê¸°í™”</button>

    <hr>

    <h2>ì›Œë“œ í´ë¼ìš°ë“œ</h2>
    <canvas id="wordcloud" width="1000" height="800" style="border: 1px solid #ccc; width: 100%; max-width: 1000px;"></canvas>

    <script>
        var examId = '';
        var isLoggedIn = false;
        var currentSubject = 'ì „ì²´';
        var currentViewMode = 'single';
        var multiYearData = null;

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì‹œí—˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        var params = new URLSearchParams(window.location.search);
        examId = params.get('id') || '';
        var title = params.get('title') || 'í‚¤ì›Œë“œ ë¶„ì„';
        document.getElementById('examTitle').textContent = title + ' - í‚¤ì›Œë“œ ë¶„ì„';

        // ê³¼ëª© ì˜µì…˜ ì„¤ì •
        function setupSubjectOptions() {
            var subjectSelect = document.getElementById('subjectSelect');
            subjectSelect.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>';

            if (examId.endsWith('-1st')) {
                // 1êµì‹œ: ë…¸ë™ë²•1, ë…¸ë™ë²•2
                subjectSelect.innerHTML += '<option value="ë…¸ë™ë²•1">ë…¸ë™ë²•1</option>';
                subjectSelect.innerHTML += '<option value="ë…¸ë™ë²•2">ë…¸ë™ë²•2</option>';
            } else if (examId.endsWith('-2nd')) {
                // 2êµì‹œ: ë¯¼ë²•, ì‚¬íšŒë³´í—˜ë²•, ê²½ì˜í•™
                subjectSelect.innerHTML += '<option value="ë¯¼ë²•">ë¯¼ë²•</option>';
                subjectSelect.innerHTML += '<option value="ì‚¬íšŒë³´í—˜ë²•">ì‚¬íšŒë³´í—˜ë²•</option>';
                subjectSelect.innerHTML += '<option value="ê²½ì˜í•™">ê²½ì˜í•™</option>';
            }
        }

        // ì¡°íšŒ ëª¨ë“œ ë³€ê²½
        function onViewModeChange() {
            currentViewMode = document.getElementById('viewModeSelect').value;

            if (currentViewMode === 'single') {
                // ë‹¨ì¼ ì—°ë„ ëª¨ë“œ
                document.getElementById('multiYearInfo').style.display = 'none';
                document.getElementById('keywordInput').disabled = false;
                document.getElementById('saveBtn').disabled = !isLoggedIn;
                loadKeywords(currentSubject);
            } else {
                // ë‹¤ê°œë…„ ëª¨ë“œ
                document.getElementById('multiYearInfo').style.display = 'block';
                document.getElementById('keywordInput').disabled = true;
                document.getElementById('saveBtn').disabled = true;
                loadMultiYearKeywords();
            }
        }

        // ê³¼ëª© ë³€ê²½ ì‹œ í‚¤ì›Œë“œ ë¶ˆëŸ¬ì˜¤ê¸°
        function onSubjectChange() {
            currentSubject = document.getElementById('subjectSelect').value;

            if (currentViewMode === 'single') {
                loadKeywords(currentSubject);
            } else {
                loadMultiYearKeywords();
            }
        }

        // ë‹¨ì¼ ì—°ë„ í‚¤ì›Œë“œ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadKeywords(subject) {
            fetch('/api/keywords/' + examId + '?subject=' + encodeURIComponent(subject))
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.keywords) {
                        document.getElementById('keywordInput').value = data.keywords;
                    } else {
                        document.getElementById('keywordInput').value = '';
                    }
                });
        }

        // ë‹¤ê°œë…„ í‚¤ì›Œë“œ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadMultiYearKeywords() {
            var parts = examId.split('-'); // ['2020', '1st']
            var baseYear = parseInt(parts[0]); // 2020
            var examType = parts[1]; // '1st' or '2nd'
            var years = currentViewMode === '3years' ? 3 : 5;

            fetch('/api/keywords/multi-year?examType=' + examType + '&subject=' + encodeURIComponent(currentSubject) + '&years=' + years + '&baseYear=' + baseYear)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    multiYearData = data;

                    // í†µí•© ì •ë³´ í‘œì‹œ
                    document.getElementById('yearRangeText').textContent = data.yearRange + ' (' + data.subject + ')';

                    // í†µí•© í‚¤ì›Œë“œë¥¼ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ (ë¹ˆë„ìˆœ ì •ë ¬)
                    var keywordList = [];
                    for (var word in data.mergedKeywords) {
                        keywordList.push({ word: word, count: data.mergedKeywords[word] });
                    }
                    keywordList.sort(function(a, b) { return b.count - a.count; });

                    var keywordText = keywordList.map(function(item) {
                        return item.word + ' (' + item.count + 'íšŒ)';
                    }).join('\n');

                    document.getElementById('keywordInput').value = keywordText;
                    document.getElementById('totalKeywordCount').textContent = keywordList.length;
                });
        }

        setupSubjectOptions();

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        fetch('/api/auth/status')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                isLoggedIn = data.loggedIn;
                if (isLoggedIn) {
                    document.getElementById('authStatus').textContent = 'ë¡œê·¸ì¸ë¨: ' + data.username;
                    document.getElementById('loginLink').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'inline';
                } else {
                    document.getElementById('authStatus').textContent = 'ë¡œê·¸ì¸ ì•ˆ ë¨ (ì½ê¸° ì „ìš©)';
                    document.getElementById('saveBtn').disabled = true;
                }
            });

        // ë¡œê·¸ì•„ì›ƒ
        document.getElementById('logoutBtn').addEventListener('click', function() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        location.reload();
                    }
                });
        });

        // ì¡°íšŒ ëª¨ë“œ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('viewModeSelect').addEventListener('change', onViewModeChange);

        // ê³¼ëª© ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('subjectSelect').addEventListener('change', onSubjectChange);

        // ì´ˆê¸° í‚¤ì›Œë“œ ë¶ˆëŸ¬ì˜¤ê¸°
        loadKeywords(currentSubject);

        // ì›Œë“œ í´ë¼ìš°ë“œ ìƒì„±
        document.getElementById('generateBtn').addEventListener('click', function() {
            var list = [];

            if (currentViewMode === 'single') {
                // ë‹¨ì¼ ì—°ë„ ëª¨ë“œ
                var text = document.getElementById('keywordInput').value;
                if (!text.trim()) {
                    alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }

                var lines = text.split('\n').filter(function(line) { return line.trim(); });
                var wordCount = {};

                lines.forEach(function(line) {
                    var word = line.trim();
                    if (word) {
                        wordCount[word] = (wordCount[word] || 0) + 1;
                    }
                });

                for (var word in wordCount) {
                    list.push([word, wordCount[word] * 10]);
                }
            } else {
                // ë‹¤ê°œë…„ ëª¨ë“œ
                if (!multiYearData || Object.keys(multiYearData.mergedKeywords).length === 0) {
                    alert('í†µí•©í•  í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                for (var word in multiYearData.mergedKeywords) {
                    list.push([word, multiYearData.mergedKeywords[word] * 10]);
                }
            }

            if (list.length === 0) {
                alert('ìœ íš¨í•œ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            var canvas = document.getElementById('wordcloud');
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            WordCloud(canvas, {
                list: list,
                gridSize: 8,
                weightFactor: function(size) {
                    return Math.pow(size, 1.5) * 0.5;
                },
                fontFamily: 'Arial, sans-serif',
                color: 'random-dark',
                rotateRatio: 0.3,
                rotationSteps: 2,
                backgroundColor: '#fff',
                minSize: 10,
                drawOutOfBound: false,
                shrinkToFit: true
            });
        });

        // ì €ì¥
        document.getElementById('saveBtn').addEventListener('click', function() {
            if (!isLoggedIn) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            var keywords = document.getElementById('keywordInput').value;
            var subject = document.getElementById('subjectSelect').value;

            fetch('/api/keywords/' + examId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keywords: keywords, subject: subject })
            })
            .then(function(response) {
                if (response.ok) {
                    alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨');
                }
            });
        });

        // ì´ˆê¸°í™”
        document.getElementById('clearBtn').addEventListener('click', function() {
            if (confirm('ì…ë ¥í•œ í‚¤ì›Œë“œë¥¼ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('keywordInput').value = '';
                var canvas = document.getElementById('wordcloud');
                var ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });
    </script>
</body>
</html>
